name: Suckless-OGL CI/CD

permissions:
  contents: write    # NÃ©cessaire pour pousser sur gh-pages et crÃ©er des releases
  pages: write       # NÃ©cessaire pour GitHub Pages
  id-token: write    # RecommandÃ© pour l'authentification moderne

on:
  push:
    branches: ["**"]
    tags: ["v*"]
  pull_request:
    branches: ["master", "main"]

jobs:
  # 1. Tests et Couverture
  test-and-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            clang \
            llvm \
            libgl1-mesa-dev \
            libglew-dev \
            libglfw3-dev \
            xorg-dev \
            xvfb \
            libgl1-mesa-dri \
            mesa-vulkan-drivers

      # Rendre le script Xvfb exÃ©cutable
      - name: Make test wrapper executable
        run: chmod +x tests/run_test_with_xvfb.sh
          
      - name: Run Coverage with Xvfb
        run: |
          # Xvfb-run s'occupe de dÃ©marrer/arrÃªter Xvfb automatiquement
          xvfb-run -a -s "-screen 0 1920x1080x24" make coverage CONTAINER_RUN=""
        env:
          CC: clang

      - name: Generate Coverage Summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat build-coverage/coverage_summary.txt || echo "No summary file generated" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build-coverage/coverage_report/
          retention-days: 30
      
      - name: Deploy Coverage to GitHub Pages
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build-coverage/coverage_report/
          
      # Sauvegarder le build pour les jobs suivants
      - name: Cache Build Directory
        uses: actions/cache/save@v4
        with:
          path: |
            build/
            build-coverage/
          key: build-${{ github.sha }}

  # 2. QualitÃ© (dÃ©pend des tests)
  lint-and-format:
    needs: test-and-coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Restore Build Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            build/
            build-coverage/
          key: build-${{ github.sha }}

      - name: Install Lint Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-format \
            clang-tidy \
            libgl1-mesa-dev \
            libglew-dev \
            libglfw3-dev \
            cmake

      - name: Check Formatting (No Apply)
        # On vÃ©rifie si git dÃ©tecte des changements aprÃ¨s make format
        run: |
          make format CONTAINER_RUN=""
          git diff --exit-code || (echo "âŒ Code not formatted! Run 'make format' locally." && exit 1)
        
      - name: Run Linter
        run: make lint CONTAINER_RUN=""
        continue-on-error: true  # Ne pas bloquer le build sur les warnings de linter

  # 3. Build de Production
  build-production:
    needs: lint-and-format
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Profiling]
    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            libgl1-mesa-dev \
            libglew-dev \
            libglfw3-dev

      - name: Build (${{ matrix.build_type }})
        run: |
          mkdir -p build-${{ matrix.build_type }}
          cmake -B build-${{ matrix.build_type }} -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build-${{ matrix.build_type }} --parallel $(nproc)

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: suckless-ogl-${{ matrix.build_type }}-${{ github.sha }}
          path: build-${{ matrix.build_type }}/app
          retention-days: 7

  # 4. Release (seulement sur master/main ou tags)
  release:
    needs: build-production
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Release Build
        uses: actions/download-artifact@v4
        with:
          name: suckless-ogl-Release-${{ github.sha }}
          path: release_dist/

      - name: Download Profiling Build
        uses: actions/download-artifact@v4
        with:
          name: suckless-ogl-Profiling-${{ github.sha }}
          path: profiling_dist/

      - name: Package Release
        run: |
          chmod +x release_dist/app
          chmod +x profiling_dist/app
          
          # Package Release
          mkdir -p release_package
          cp release_dist/app release_package/
          cp -r assets/ shaders/ release_package/ 2>/dev/null || true
          tar -czvf suckless-ogl-linux-x64-release.tar.gz -C release_package .
          
          # Package Profiling
          mkdir -p profiling_package
          cp profiling_dist/app profiling_package/
          cp -r assets/ shaders/ profiling_package/ 2>/dev/null || true
          tar -czvf suckless-ogl-linux-x64-profiling.tar.gz -C profiling_package .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest-master' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('Build {0}', github.run_number) }}
          body: |
            ## ðŸ“¦ Builds
            
            - **Release**: Optimized build (O3 + LTO)
            - **Profiling**: Optimized with debug symbols (O3 + LTO + debug info)
            
            ## ðŸ“Š Coverage Report
            Coverage report available at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/coverage/
            
            ## âœ… Tests
            All tests passed âœ“
          files: |
            suckless-ogl-linux-x64-release.tar.gz
            suckless-ogl-linux-x64-profiling.tar.gz
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 5. Test Docker Build (optionnel, parallÃ¨le)
  docker-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || contains(github.event.head_commit.message, '[docker]')
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: docker build -t suckless-ogl:test .
        
      - name: Test Docker Image
        run: |
          docker run --rm \
            -e DISPLAY=$DISPLAY \
            -v /tmp/.X11-unix:/tmp/.X11-unix \
            suckless-ogl:test /bin/bash -c "echo 'Docker build successful'"