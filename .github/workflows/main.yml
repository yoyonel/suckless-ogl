name: Suckless-OGL CI/CD

permissions:
  contents: write
  pages: write
  pull-requests: write
  id-token: write

on:
  push:
    # On ne lance au push QUE sur master pour mettre √† jour le site officiel et les releases
    branches: ["master", "main"]
    tags: ["v*"]
  pull_request:
    # Pour tout le reste, on passe par les PRs (master/main comme cibles)
    # Cela garantit un seul run par commit dans une PR
    branches: ["master", "main"]

jobs:
  # --- JOB 1 : TESTS, COUVERTURE ET CAPTURES VISUELLES ---
  test-and-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake clang llvm \
            libgl1-mesa-dev libglew-dev libglfw3-dev \
            xorg-dev xvfb libgl1-mesa-dri mesa-vulkan-drivers \
            imagemagick

      - name: Make test wrapper executable
        run: chmod +x tests/run_test_with_xvfb.sh
          
      - name: Run Coverage and Tests
        id: run_tests
        continue-on-error: true
        run: |
          # Ex√©cution des tests via Xvfb
          xvfb-run -a -s "-screen 0 1920x1080x24" make coverage CONTAINER_RUN="" CC=clang

      - name: Generate Visual Artifacts
        if: always()
        run: |
          # Pr√©paration des dossiers
          mkdir -p visual_artifacts/${{ github.sha }}
          mkdir -p build-coverage/coverage_report/visual_tests
          
          # Conversion RAW -> PNG (Utilisation de 'convert' pour compatibilit√© Ubuntu)
          # On capture la r√©f√©rence, le rendu actuel et la carte de diff√©rence
          [ -f tests/ref_frame.raw ] && convert -size 1024x768 -depth 8 rgb:tests/ref_frame.raw -flip visual_artifacts/${{ github.sha }}/ref.png || echo "No ref"
          [ -f tests/failed_frame_actual.raw ] && convert -size 1024x768 -depth 8 rgb:tests/failed_frame_actual.raw -flip visual_artifacts/${{ github.sha }}/actual.png || echo "No actual"
          [ -f tests/failed_diff_map.raw ] && convert -size 1024x768 -depth 8 rgb:tests/failed_diff_map.raw -flip visual_artifacts/${{ github.sha }}/diff.png || echo "No diff"

          # G√©n√©ration de l'index HTML interactif (Comparaison par survol)
          cat <<EOF > build-coverage/coverage_report/visual_tests/index.html
          <!DOCTYPE html>
          <html>
          <head>
            <title>Visual Regression Report</title>
            <style>
              body { font-family: sans-serif; background: #121212; color: #eee; padding: 20px; text-align: center; }
              .compare-container { position: relative; width: 1024px; height: 768px; margin: 0 auto; border: 2px solid #444; cursor: crosshair; }
              .compare-container img { position: absolute; top: 0; left: 0; width: 100%; opacity: 0; transition: opacity 0.2s; }
              .compare-container .img-ref { opacity: 1; }
              .compare-container:hover .img-actual { opacity: 1; }
              .diff-map { margin-top: 20px; border: 2px solid #f00; width: 1024px; }
            </style>
          </head>
          <body>
            <h1>Visual Regression Analysis</h1>
            <p>Passez la souris sur l'image pour comparer : <b>R√©f√©rence</b> vs <b>Rendu PR</b></p>
            <div class="compare-container">
              <img src="ref.png" class="img-ref">
              <img src="actual.png" class="img-actual">
            </div>
            <h3>Carte des diff√©rences (Diff Map)</h3>
            <img src="diff.png" class="diff-map">
            <br><a href="../index.html" style="color: #00ff95;">Retour au Rapport de Couverture</a>
          </body>
          </html>
          EOF

          # Copie des PNG pour le rapport statique
          cp visual_artifacts/${{ github.sha }}/*.png build-coverage/coverage_report/visual_tests/ 2>/dev/null || true

      - name: Upload Images to Visual Storage Branch
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./visual_artifacts
          publish_branch: visual-artifacts
          keep_files: true

      - name: Post Visual Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## üé® Visual Regression Report (${{ github.sha }})
            
            | Reference | Actual (PR) | Difference Map |
            |:---:|:---:|:---:|
            | ![Ref](https://raw.githubusercontent.com/${{ github.repository }}/visual-artifacts/${{ github.sha }}/ref.png) | ![Actual](https://raw.githubusercontent.com/${{ github.repository }}/visual-artifacts/${{ github.sha }}/actual.png) | ![Diff](https://raw.githubusercontent.com/${{ github.repository }}/visual-artifacts/${{ github.sha }}/diff.png) |
            
            > [!TIP]
            > Si ces changements visuels sont attendus, mettez √† jour `tests/ref_frame.raw`.

      - name: Deploy Coverage to GitHub Pages
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build-coverage/coverage_report/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: build-coverage/coverage_report/

  # --- JOB 2 : QUALIT√â ET LINT ---
  lint-and-format:
    needs: test-and-coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install clang-format 19.1.7 via pip
        run: |
          pip install clang-format==19.1.7
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libglew-dev libglfw3-dev cmake clang-tidy
      - name: Run Format & Lint
        run: |
          clang-format --version
          make format CONTAINER_RUN=""
          git diff --exit-code || (echo "‚ùå Format error" && exit 1)
          make lint CONTAINER_RUN=""

  # --- JOB 3 : BUILDS DE PRODUCTION ---
  build-production:
    needs: lint-and-format
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [Release, Profiling]
    steps:
      - uses: actions/checkout@v4
      - name: Install Deps
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake libgl1-mesa-dev libglew-dev libglfw3-dev
      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          cmake --build build --parallel $(nproc)
      - name: Upload Binaries
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.build_type }}
          path: build/app

  # --- JOB 4 : RELEASE ---
  release:
    needs: build-production
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with: { path: artifacts }
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: artifacts/app-*/app
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}