#!/bin/sh
#
# Pre-push hook to run linter only if source files changed
#

z40=0000000000000000000000000000000000000000
run_lint=0

echo "Running pre-push hook..."

while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = "$z40" ]; then
        # Handle delete
        continue
    fi

    if [ "$remote_sha" = "$z40" ]; then
        # New branch, try to compare against default branch
        if git rev-parse --verify origin/main >/dev/null 2>&1; then
            range="origin/main...$local_sha"
        elif git rev-parse --verify origin/master >/dev/null 2>&1; then
            range="origin/master...$local_sha"
        else
            echo "âš ï¸  Could not determine base branch. Assessing all files."
            run_lint=1
            break
        fi
    else
        range="$remote_sha..$local_sha"
    fi

    # Check if any .c or .h file is in the list of changed files
    if git diff --name-only "$range" 2>/dev/null | grep -E '\.(c|h)$' > /dev/null 2>&1; then
        run_lint=1
        echo "   -> Detected source changes in $local_ref"
        break
    fi
done

if [ "$run_lint" -eq 1 ]; then
    echo "ğŸ” Sources modified. Running 'make lint'..."
    make lint
    if [ $? -ne 0 ]; then
        echo "âŒ Lint failed. Push aborted."
        exit 1
    fi
    echo "âœ… Lint passed."
else
    echo "â­ï¸  No source changes detected. Skipping lint."
fi

exit 0
